<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gaias Grounds ‚Äî Of the Earth ¬∑ For the World</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Josefin+Sans:wght@100;200;300;400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root {
      --earth:      #1E1208;
      --bark:       #2E1A0A;
      --clay:       #7A4F2E;
      --gold:       #C4A25A;
      --cream:      #EDE0CC;
      --parchment:  #F2EAD8;
      --mist:       #F8F3EB;
      --moss:       #3D4A32;
      --sage:       #6B7C5E;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Cormorant Garamond', Georgia, serif;
      background: var(--parchment);
      color: var(--earth);
      height: 100vh;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 1000;
      background: rgba(242,234,216,0.97);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(122,79,46,0.15);
      padding: 0 2rem;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo { display: flex; align-items: center; gap: 0.85rem; }

    .header-filters { display: flex; align-items: center; gap: 1rem; }
    .filter-group   { display: flex; align-items: center; gap: 0.5rem; }

    .filter-label {
      font-family: 'Josefin Sans', sans-serif;
      font-weight: 300;
      font-size: 0.52rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: rgba(122,79,46,0.4);
    }

    select {
      background: rgba(237,224,204,0.8);
      border: 1px solid rgba(122,79,46,0.2);
      color: var(--earth);
      font-family: 'Cormorant Garamond', serif;
      font-size: 0.85rem;
      padding: 0.3rem 0.6rem;
      border-radius: 3px;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s;
    }
    select:hover, select:focus { border-color: var(--clay); }

    .count-badge {
      font-family: 'Josefin Sans', sans-serif;
      font-weight: 200;
      font-size: 0.58rem;
      color: rgba(122,79,46,0.38);
      letter-spacing: 0.15em;
    }

    /* ‚îÄ‚îÄ CONFIG BANNER (shown when using placeholder keys) ‚îÄ‚îÄ */
    .config-banner {
      position: fixed;
      top: 64px; left: 0; right: 0;
      z-index: 900;
      background: #2E1A0A;
      color: #EDE0CC;
      padding: 0.65rem 2rem;
      font-family: 'Josefin Sans', sans-serif;
      font-size: 0.6rem;
      letter-spacing: 0.15em;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .config-banner a { color: var(--gold); text-decoration: underline; cursor: pointer; }
    .config-banner.hidden { display: none; }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .layout {
      display: flex;
      height: 100vh;
      padding-top: 64px;
    }
    .layout.with-banner { padding-top: 100px; }

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar {
      width: 380px; min-width: 380px;
      background: var(--mist);
      border-right: 1px solid rgba(122,79,46,0.12);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 1.5rem 1.5rem 1rem;
      border-bottom: 1px solid rgba(122,79,46,0.09);
    }

    .sidebar-title {
      font-family: 'Josefin Sans', sans-serif;
      font-weight: 200;
      font-size: 0.5rem;
      letter-spacing: 0.42em;
      text-transform: uppercase;
      color: rgba(122,79,46,0.38);
      margin-bottom: 0.6rem;
    }

    .search-input {
      width: 100%;
      background: rgba(242,234,216,0.7);
      border: 1px solid rgba(122,79,46,0.18);
      color: var(--earth);
      font-family: 'Cormorant Garamond', serif;
      font-size: 1rem;
      padding: 0.6rem 0.9rem;
      border-radius: 4px;
      outline: none;
      transition: border-color 0.2s;
    }
    .search-input::placeholder { color: rgba(122,79,46,0.28); font-style: italic; }
    .search-input:focus { border-color: var(--clay); }

    .locations-list {
      overflow-y: auto;
      flex: 1;
      padding: 0.75rem;
    }
    .locations-list::-webkit-scrollbar { width: 4px; }
    .locations-list::-webkit-scrollbar-thumb { background: rgba(200,153,90,0.2); border-radius: 2px; }

    .location-card {
      padding: 1rem 1.1rem;
      border: 1px solid rgba(200,153,90,0.1);
      border-radius: 6px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      background: rgba(242,234,216,0.55);
      position: relative;
      overflow: hidden;
    }
    .location-card::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 3px;
      background: var(--clay);
      transform: scaleY(0);
      transition: transform 0.2s ease;
      transform-origin: bottom;
    }
    .location-card:hover { border-color: rgba(122,79,46,0.26); background: rgba(237,224,204,0.8); }
    .location-card:hover::before,
    .location-card.active::before { transform: scaleY(1); }
    .location-card.active { border-color: rgba(122,79,46,0.38); background: rgba(237,224,204,0.9); }

    .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.35rem; }
    .card-emoji { font-size: 1.2rem; line-height: 1; margin-right: 0.5rem; }
    .card-name { font-size: 1rem; font-weight: 500; color: var(--earth); flex: 1; }
    .card-rating { font-family: 'Josefin Sans', sans-serif; font-weight: 300; font-size: 0.62rem; color: var(--clay); }
    .card-location { font-size: 0.78rem; color: rgba(122,79,46,0.58); font-style: italic; margin-bottom: 0.38rem; }
    .card-tags { display: flex; gap: 0.4rem; flex-wrap: wrap; }

    .tag {
      font-family: 'Josefin Sans', sans-serif;
      font-weight: 300;
      font-size: 0.48rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      padding: 0.12rem 0.42rem;
      border-radius: 2px;
      border: 1px solid;
    }
    .tag-type  { border-color: rgba(61,74,50,0.28); color: var(--sage); }
    .tag-roast { border-color: rgba(122,79,46,0.22); color: var(--clay); }
    .tag-cert  { border-color: rgba(196,162,90,0.35); color: #8C6820; }

    /* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
    #map { flex: 1; }
    .leaflet-tile { filter: sepia(0.2) saturate(0.9) brightness(1.04); }

    /* ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ */
    .detail-panel {
      position: fixed;
      right: 0; top: 64px; bottom: 0;
      width: 420px;
      background: var(--mist);
      border-left: 1px solid rgba(122,79,46,0.15);
      transform: translateX(100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 500;
      overflow-y: auto;
    }
    .detail-panel.open { transform: translateX(0); }
    .detail-panel::-webkit-scrollbar { width: 4px; }
    .detail-panel::-webkit-scrollbar-thumb { background: rgba(200,153,90,0.2); }

    .detail-close {
      position: absolute; top: 1rem; right: 1rem;
      background: none;
      border: 1px solid rgba(122,79,46,0.22);
      color: var(--clay);
      width: 28px; height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .detail-close:hover { background: rgba(122,79,46,0.07); }

    .detail-hero {
      padding: 2.5rem 1.75rem 1.5rem;
      background: linear-gradient(135deg, rgba(237,224,204,0.7) 0%, rgba(248,243,235,0.3) 100%);
      border-bottom: 1px solid rgba(122,79,46,0.09);
    }
    .detail-emoji { font-size: 3rem; margin-bottom: 0.75rem; display: block; }
    .detail-name { font-size: 1.5rem; font-weight: 400; color: var(--earth); line-height: 1.2; margin-bottom: 0.35rem; }
    .detail-location { font-size: 0.85rem; color: var(--clay); font-style: italic; margin-bottom: 0.85rem; }
    .detail-meta { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .detail-description { font-size: 0.95rem; line-height: 1.6; color: rgba(46,26,10,0.62); font-style: italic; }

    .detail-section {
      padding: 1.25rem 1.75rem;
      border-bottom: 1px solid rgba(200,153,90,0.08);
    }
    .section-label {
      font-family: 'Josefin Sans', sans-serif;
      font-weight: 200;
      font-size: 0.48rem;
      letter-spacing: 0.42em;
      text-transform: uppercase;
      color: rgba(122,79,46,0.38);
      margin-bottom: 0.85rem;
    }

    .product-item {
      padding: 0.85rem 1rem;
      background: rgba(242,234,216,0.55);
      border: 1px solid rgba(122,79,46,0.09);
      border-radius: 5px;
      margin-bottom: 0.5rem;
    }
    .product-item:hover { border-color: rgba(122,79,46,0.22); }
    .product-top { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.3rem; }
    .product-name { font-weight: 500; font-size: 0.95rem; color: var(--earth); }
    .product-price { font-family: 'Josefin Sans', sans-serif; font-weight: 300; font-size: 0.65rem; color: var(--clay); }
    .product-notes { font-size: 0.78rem; color: rgba(122,79,46,0.52); font-style: italic; }
    .product-meta { font-size: 0.72rem; color: rgba(122,79,46,0.42); margin-top: 0.25rem; }

    .cert-chips { display: flex; gap: 0.4rem; flex-wrap: wrap; }

    .contact-grid { display: flex; flex-direction: column; gap: 0.5rem; }
    .contact-item { display: flex; align-items: center; gap: 0.75rem; font-size: 0.85rem; }
    .contact-icon {
      font-family: 'Josefin Sans', sans-serif;
      font-weight: 300;
      font-size: 0.52rem;
      color: rgba(122,79,46,0.38);
      width: 38px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    .contact-value a { color: var(--clay); text-decoration: none; }
    .contact-value a:hover { text-decoration: underline; }

    /* ‚îÄ‚îÄ VERIFIED BADGE ‚îÄ‚îÄ */
    .verified-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-family: 'Josefin Sans', sans-serif;
      font-size: 0.46rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #3D5C38;
      border: 1px solid rgba(61,92,56,0.3);
      padding: 0.15rem 0.5rem;
      border-radius: 2px;
    }

    /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
    .loading-overlay {
      position: fixed; inset: 0;
      background: var(--parchment);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2rem;
      transition: opacity 0.7s ease;
    }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }

    @keyframes dotbounce {
      0%, 100% { transform: scale(1); opacity: 0.25; }
      50% { transform: scale(1.6); opacity: 0.75; }
    }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(14px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Leaflet popup */
    .leaflet-popup-content-wrapper {
      background: var(--mist) !important;
      border: 1px solid rgba(122,79,46,0.2) !important;
      border-radius: 4px !important;
      box-shadow: 0 8px 32px rgba(30,18,8,0.16) !important;
    }
    .leaflet-popup-tip { background: var(--mist) !important; }
    .leaflet-popup-content { margin: 12px 16px !important; font-family: 'Cormorant Garamond', serif !important; }
    .popup-name { font-weight: 500; font-size: 1rem; color: var(--earth); margin-bottom: 0.2rem; }
    .popup-sub  { font-size: 0.8rem; color: rgba(122,79,46,0.6); font-style: italic; }
    .popup-btn  {
      display: inline-block; margin-top: 0.5rem;
      font-family: 'Josefin Sans', sans-serif; font-weight: 300;
      font-size: 0.52rem; letter-spacing: 0.22em; text-transform: uppercase;
      color: var(--clay); border: 1px solid rgba(122,79,46,0.28);
      padding: 0.25rem 0.6rem; border-radius: 2px; cursor: pointer;
      background: none; transition: all 0.2s;
    }
    .popup-btn:hover { background: rgba(122,79,46,0.06); }

    @media (max-width: 768px) {
      .sidebar { display: none; }
      .detail-panel { width: 100%; }
    }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ‚öôÔ∏è  CONFIGURATION ‚Äî replace these two values
     with your Supabase Project URL and anon key
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
  const SUPABASE_URL  = 'https://myduukysrcdelylnbwtl.supabase.co';
  const SUPABASE_ANON = 'sb_publishable_ecfUlk3XHIvIOLuqiIpnuA_V59Ak-6z';

  const IS_CONFIGURED = !SUPABASE_URL.includes('YOUR_');
</script>

<!-- Config banner (only shown until keys are set) -->
<div class="config-banner" id="config-banner">
  ‚öô &nbsp;Not connected to Supabase yet ‚Äî showing demo data.
  &nbsp;Open this file and replace <strong>SUPABASE_URL</strong> and <strong>SUPABASE_ANON_KEY</strong> at the top of the &lt;script&gt; block.
</div>

<!-- Loading Screen -->
<div class="loading-overlay" id="loading">
  <div style="display:flex;flex-direction:column;align-items:center;gap:2.2rem;animation:fadeUp 0.8s ease forwards;">
    <svg width="88" height="88" viewBox="60 60 80 80" fill="none">
      <defs><clipPath id="load-clip"><circle cx="100" cy="100" r="39"/></clipPath></defs>
      <g clip-path="url(#load-clip)">
        <path d="M 67.1 119.0 L 68.4 121.2 L 70.0 123.3 L 71.6 125.2 L 73.4 127.1 L 75.2 128.8 L 77.3 130.4 L 79.4 131.9 L 81.6 133.2 L 83.8 134.4 L 86.2 135.4 L 88.6 136.3 L 91.1 136.9 L 93.6 137.5 L 96.2 137.8 L 98.7 138.0 L 101.3 138.0 L 103.8 137.8 L 106.4 137.5 L 108.9 136.9 L 111.4 136.3 L 113.8 135.4 L 116.2 134.4 L 118.4 133.2 L 120.6 131.9 L 122.7 130.4 L 124.8 128.8 L 126.6 127.1 L 128.4 125.2 L 130.0 123.3 L 131.6 121.2 L 132.9 119.0 L 131.6 116.8 L 130.0 114.7 L 128.4 112.8 L 126.6 110.9 L 124.8 109.2 L 122.7 107.6 L 120.6 106.1 L 118.4 104.8 L 116.2 103.6 L 113.8 102.6 L 111.4 101.7 L 108.9 101.1 L 106.4 100.5 L 103.8 100.2 L 101.3 100.0 L 98.7 100.0 L 96.2 100.2 L 93.6 100.5 L 91.1 101.1 L 88.6 101.7 L 86.2 102.6 L 83.8 103.6 L 81.6 104.8 L 79.4 106.1 L 77.3 107.6 L 75.2 109.2 L 73.4 110.9 L 71.6 112.8 L 70.0 114.7 L 68.4 116.8 L 67.1 119.0 Z" stroke="#7A4F2E" stroke-width="0.6" fill="rgba(122,79,46,0.09)"/>
        <path d="M 67.1 81.0 L 65.9 83.3 L 64.8 85.6 L 63.9 88.0 L 63.2 90.5 L 62.7 93.0 L 62.3 95.5 L 62.0 98.1 L 62.0 100.6 L 62.1 103.2 L 62.4 105.8 L 62.9 108.3 L 63.6 110.8 L 64.4 113.2 L 65.3 115.6 L 66.5 117.9 L 67.8 120.1 L 69.2 122.2 L 70.8 124.3 L 72.5 126.2 L 74.3 128.0 L 76.2 129.7 L 78.3 131.2 L 80.4 132.6 L 82.7 133.8 L 85.0 134.9 L 87.4 135.9 L 89.9 136.6 L 92.4 137.2 L 94.9 137.7 L 97.4 137.9 L 100.0 138.0 L 101.2 135.7 L 102.3 133.4 L 103.2 131.0 L 103.9 128.5 L 104.4 126.0 L 104.8 123.5 L 105.0 120.9 L 105.1 118.4 L 105.0 115.8 L 104.7 113.2 L 104.2 110.7 L 103.5 108.2 L 102.7 105.8 L 101.8 103.4 L 100.6 101.1 L 99.3 98.9 L 97.9 96.8 L 96.3 94.7 L 94.6 92.8 L 92.8 91.0 L 90.9 89.3 L 88.8 87.8 L 86.6 86.4 L 84.4 85.2 L 82.1 84.1 L 79.7 83.1 L 77.2 82.4 L 74.7 81.8 L 72.2 81.3 L 69.7 81.1 L 67.1 81.0 Z" stroke="#7A4F2E" stroke-width="0.6" fill="rgba(122,79,46,0.09)"/>
        <path d="M 100.0 62.0 L 97.4 62.1 L 94.9 62.3 L 92.4 62.8 L 89.9 63.4 L 87.4 64.1 L 85.0 65.1 L 82.7 66.2 L 80.4 67.4 L 78.3 68.8 L 76.2 70.3 L 74.3 72.0 L 72.5 73.8 L 70.8 75.7 L 69.2 77.8 L 67.8 79.9 L 66.5 82.1 L 65.3 84.4 L 64.4 86.8 L 63.6 89.2 L 62.9 91.7 L 62.4 94.2 L 62.1 96.8 L 62.0 99.4 L 62.0 101.9 L 62.3 104.5 L 62.7 107.0 L 63.2 109.5 L 63.9 112.0 L 64.8 114.4 L 65.9 116.7 L 67.1 119.0 L 69.7 118.9 L 72.2 118.7 L 74.7 118.2 L 77.2 117.6 L 79.7 116.9 L 82.1 115.9 L 84.4 114.8 L 86.6 113.6 L 88.8 112.2 L 90.9 110.7 L 92.8 109.0 L 94.6 107.2 L 96.3 105.3 L 97.9 103.2 L 99.3 101.1 L 100.6 98.9 L 101.8 96.6 L 102.7 94.2 L 103.5 91.8 L 104.2 89.3 L 104.7 86.8 L 105.0 84.2 L 105.1 81.6 L 105.0 79.1 L 104.8 76.5 L 104.4 74.0 L 103.9 71.5 L 103.2 69.0 L 102.3 66.6 L 101.2 64.3 L 100.0 62.0 Z" stroke="#7A4F2E" stroke-width="0.6" fill="rgba(122,79,46,0.09)"/>
        <path d="M 132.9 81.0 L 131.6 78.8 L 130.0 76.7 L 128.4 74.8 L 126.6 72.9 L 124.8 71.2 L 122.7 69.6 L 120.6 68.1 L 118.4 66.8 L 116.2 65.6 L 113.8 64.6 L 111.4 63.7 L 108.9 63.1 L 106.4 62.5 L 103.8 62.2 L 101.3 62.0 L 98.7 62.0 L 96.2 62.2 L 93.6 62.5 L 91.1 63.1 L 88.6 63.7 L 86.2 64.6 L 83.8 65.6 L 81.6 66.8 L 79.4 68.1 L 77.3 69.6 L 75.2 71.2 L 73.4 72.9 L 71.6 74.8 L 70.0 76.7 L 68.4 78.8 L 67.1 81.0 L 68.4 83.2 L 70.0 85.3 L 71.6 87.2 L 73.4 89.1 L 75.2 90.8 L 77.3 92.4 L 79.4 93.9 L 81.6 95.2 L 83.8 96.4 L 86.2 97.4 L 88.6 98.3 L 91.1 98.9 L 93.6 99.5 L 96.2 99.8 L 98.7 100.0 L 101.3 100.0 L 103.8 99.8 L 106.4 99.5 L 108.9 98.9 L 111.4 98.3 L 113.8 97.4 L 116.2 96.4 L 118.4 95.2 L 120.6 93.9 L 122.7 92.4 L 124.8 90.8 L 126.6 89.1 L 128.4 87.2 L 130.0 85.3 L 131.6 83.2 L 132.9 81.0 Z" stroke="#7A4F2E" stroke-width="0.6" fill="rgba(122,79,46,0.09)"/>
        <path d="M 132.9 119.0 L 134.1 116.7 L 135.2 114.4 L 136.1 112.0 L 136.8 109.5 L 137.3 107.0 L 137.7 104.5 L 138.0 101.9 L 138.0 99.4 L 137.9 96.8 L 137.6 94.2 L 137.1 91.7 L 136.4 89.2 L 135.6 86.8 L 134.7 84.4 L 133.5 82.1 L 132.2 79.9 L 130.8 77.8 L 129.2 75.7 L 127.5 73.8 L 125.7 72.0 L 123.8 70.3 L 121.7 68.8 L 119.6 67.4 L 117.3 66.2 L 115.0 65.1 L 112.6 64.1 L 110.1 63.4 L 107.6 62.8 L 105.1 62.3 L 102.6 62.1 L 100.0 62.0 L 98.8 64.3 L 97.7 66.6 L 96.8 69.0 L 96.1 71.5 L 95.6 74.0 L 95.2 76.5 L 95.0 79.1 L 94.9 81.6 L 95.0 84.2 L 95.3 86.8 L 95.8 89.3 L 96.5 91.8 L 97.3 94.2 L 98.2 96.6 L 99.4 98.9 L 100.7 101.1 L 102.1 103.2 L 103.7 105.3 L 105.4 107.2 L 107.2 109.0 L 109.1 110.7 L 111.2 112.2 L 113.4 113.6 L 115.6 114.8 L 117.9 115.9 L 120.3 116.9 L 122.8 117.6 L 125.3 118.2 L 127.8 118.7 L 130.3 118.9 L 132.9 119.0 Z" stroke="#7A4F2E" stroke-width="0.6" fill="rgba(122,79,46,0.09)"/>
        <path d="M 100.0 138.0 L 102.6 137.9 L 105.1 137.7 L 107.6 137.2 L 110.1 136.6 L 112.6 135.9 L 115.0 134.9 L 117.3 133.8 L 119.6 132.6 L 121.7 131.2 L 123.8 129.7 L 125.7 128.0 L 127.5 126.2 L 129.2 124.3 L 130.8 122.2 L 132.2 120.1 L 133.5 117.9 L 134.7 115.6 L 135.6 113.2 L 136.4 110.8 L 137.1 108.3 L 137.6 105.8 L 137.9 103.2 L 138.0 100.6 L 138.0 98.1 L 137.7 95.5 L 137.3 93.0 L 136.8 90.5 L 136.1 88.0 L 135.2 85.6 L 134.1 83.3 L 132.9 81.0 L 130.3 81.1 L 127.8 81.3 L 125.3 81.8 L 122.8 82.4 L 120.3 83.1 L 117.9 84.1 L 115.6 85.2 L 113.4 86.4 L 111.2 87.8 L 109.1 89.3 L 107.2 91.0 L 105.4 92.8 L 103.7 94.7 L 102.1 96.8 L 100.7 98.9 L 99.4 101.1 L 98.2 103.4 L 97.3 105.8 L 96.5 108.2 L 95.8 110.7 L 95.3 113.2 L 95.0 115.8 L 94.9 118.4 L 95.0 120.9 L 95.2 123.5 L 95.6 126.0 L 96.1 128.5 L 96.8 131.0 L 97.7 133.4 L 98.8 135.7 L 100.0 138.0 Z" stroke="#7A4F2E" stroke-width="0.6" fill="rgba(122,79,46,0.09)"/>
        <!-- Coffee bean -->
        <ellipse cx="100" cy="100" rx="6" ry="10" fill="rgba(122,79,46,0.36)" stroke="#7A4F2E" stroke-width="1.1" transform="rotate(-20 100 100)"/>
        <path d="M100 91 C97 94, 103 97, 100 100 C97 103, 103 106, 100 109" fill="none" stroke="#7A4F2E" stroke-width="0.85" stroke-linecap="round" transform="rotate(-20 100 100)" opacity="0.75"/>
      </g>
    </svg>
    <div style="display:flex;flex-direction:column;align-items:center;gap:1.4rem;">
      <span style="font-family:'Josefin Sans',sans-serif;font-weight:200;font-size:0.42rem;letter-spacing:0.7em;text-transform:uppercase;color:rgba(122,79,46,0.32);">Gaias</span>
      <div style="font-family:'Cormorant Garamond',serif;font-weight:300;font-size:3rem;letter-spacing:0.6em;padding-left:0.6em;text-transform:uppercase;color:#1E1208;line-height:1;">Grounds</div>
      <div style="font-family:'Cormorant Garamond',serif;font-style:italic;font-weight:300;font-size:0.9rem;letter-spacing:0.22em;color:rgba(122,79,46,0.48);">Of the Earth ¬∑ For the World</div>
    </div>
    <div style="display:flex;gap:0.5rem;margin-top:0.2rem;">
      <div style="width:5px;height:5px;background:#7A4F2E;border-radius:50%;animation:dotbounce 1.1s infinite ease-in-out;"></div>
      <div style="width:5px;height:5px;background:#7A4F2E;border-radius:50%;animation:dotbounce 1.1s 0.18s infinite ease-in-out;"></div>
      <div style="width:5px;height:5px;background:#7A4F2E;border-radius:50%;animation:dotbounce 1.1s 0.36s infinite ease-in-out;"></div>
    </div>
  </div>
</div>

<!-- Header -->
<header>
  <div class="logo">
    <svg width="34" height="34" viewBox="60 60 80 80" fill="none">
      <defs><clipPath id="hdr-clip"><circle cx="100" cy="100" r="39"/></clipPath></defs>
      <g clip-path="url(#hdr-clip)">
        <path d="M 67.1 119.0 L 68.4 121.2 L 70.0 123.3 L 71.6 125.2 L 73.4 127.1 L 75.2 128.8 L 77.3 130.4 L 79.4 131.9 L 81.6 133.2 L 83.8 134.4 L 86.2 135.4 L 88.6 136.3 L 91.1 136.9 L 93.6 137.5 L 96.2 137.8 L 98.7 138.0 L 101.3 138.0 L 103.8 137.8 L 106.4 137.5 L 108.9 136.9 L 111.4 136.3 L 113.8 135.4 L 116.2 134.4 L 118.4 133.2 L 120.6 131.9 L 122.7 130.4 L 124.8 128.8 L 126.6 127.1 L 128.4 125.2 L 130.0 123.3 L 131.6 121.2 L 132.9 119.0 L 131.6 116.8 L 130.0 114.7 L 128.4 112.8 L 126.6 110.9 L 124.8 109.2 L 122.7 107.6 L 120.6 106.1 L 118.4 104.8 L 116.2 103.6 L 113.8 102.6 L 111.4 101.7 L 108.9 101.1 L 106.4 100.5 L 103.8 100.2 L 101.3 100.0 L 98.7 100.0 L 96.2 100.2 L 93.6 100.5 L 91.1 101.1 L 88.6 101.7 L 86.2 102.6 L 83.8 103.6 L 81.6 104.8 L 79.4 106.1 L 77.3 107.6 L 75.2 109.2 L 73.4 110.9 L 71.6 112.8 L 70.0 114.7 L 68.4 116.8 L 67.1 119.0 Z" stroke="#7A4F2E" stroke-width="0.7" fill="rgba(122,79,46,0.1)"/>
        <path d="M 67.1 81.0 L 65.9 83.3 L 64.8 85.6 L 63.9 88.0 L 63.2 90.5 L 62.7 93.0 L 62.3 95.5 L 62.0 98.1 L 62.0 100.6 L 62.1 103.2 L 62.4 105.8 L 62.9 108.3 L 63.6 110.8 L 64.4 113.2 L 65.3 115.6 L 66.5 117.9 L 67.8 120.1 L 69.2 122.2 L 70.8 124.3 L 72.5 126.2 L 74.3 128.0 L 76.2 129.7 L 78.3 131.2 L 80.4 132.6 L 82.7 133.8 L 85.0 134.9 L 87.4 135.9 L 89.9 136.6 L 92.4 137.2 L 94.9 137.7 L 97.4 137.9 L 100.0 138.0 L 101.2 135.7 L 102.3 133.4 L 103.2 131.0 L 103.9 128.5 L 104.4 126.0 L 104.8 123.5 L 105.0 120.9 L 105.1 118.4 L 105.0 115.8 L 104.7 113.2 L 104.2 110.7 L 103.5 108.2 L 102.7 105.8 L 101.8 103.4 L 100.6 101.1 L 99.3 98.9 L 97.9 96.8 L 96.3 94.7 L 94.6 92.8 L 92.8 91.0 L 90.9 89.3 L 88.8 87.8 L 86.6 86.4 L 84.4 85.2 L 82.1 84.1 L 79.7 83.1 L 77.2 82.4 L 74.7 81.8 L 72.2 81.3 L 69.7 81.1 L 67.1 81.0 Z" stroke="#7A4F2E" stroke-width="0.7" fill="rgba(122,79,46,0.1)"/>
        <path d="M 100.0 62.0 L 97.4 62.1 L 94.9 62.3 L 92.4 62.8 L 89.9 63.4 L 87.4 64.1 L 85.0 65.1 L 82.7 66.2 L 80.4 67.4 L 78.3 68.8 L 76.2 70.3 L 74.3 72.0 L 72.5 73.8 L 70.8 75.7 L 69.2 77.8 L 67.8 79.9 L 66.5 82.1 L 65.3 84.4 L 64.4 86.8 L 63.6 89.2 L 62.9 91.7 L 62.4 94.2 L 62.1 96.8 L 62.0 99.4 L 62.0 101.9 L 62.3 104.5 L 62.7 107.0 L 63.2 109.5 L 63.9 112.0 L 64.8 114.4 L 65.9 116.7 L 67.1 119.0 L 69.7 118.9 L 72.2 118.7 L 74.7 118.2 L 77.2 117.6 L 79.7 116.9 L 82.1 115.9 L 84.4 114.8 L 86.6 113.6 L 88.8 112.2 L 90.9 110.7 L 92.8 109.0 L 94.6 107.2 L 96.3 105.3 L 97.9 103.2 L 99.3 101.1 L 100.6 98.9 L 101.8 96.6 L 102.7 94.2 L 103.5 91.8 L 104.2 89.3 L 104.7 86.8 L 105.0 84.2 L 105.1 81.6 L 105.0 79.1 L 104.8 76.5 L 104.4 74.0 L 103.9 71.5 L 103.2 69.0 L 102.3 66.6 L 101.2 64.3 L 100.0 62.0 Z" stroke="#7A4F2E" stroke-width="0.7" fill="rgba(122,79,46,0.1)"/>
        <path d="M 132.9 81.0 L 131.6 78.8 L 130.0 76.7 L 128.4 74.8 L 126.6 72.9 L 124.8 71.2 L 122.7 69.6 L 120.6 68.1 L 118.4 66.8 L 116.2 65.6 L 113.8 64.6 L 111.4 63.7 L 108.9 63.1 L 106.4 62.5 L 103.8 62.2 L 101.3 62.0 L 98.7 62.0 L 96.2 62.2 L 93.6 62.5 L 91.1 63.1 L 88.6 63.7 L 86.2 64.6 L 83.8 65.6 L 81.6 66.8 L 79.4 68.1 L 77.3 69.6 L 75.2 71.2 L 73.4 72.9 L 71.6 74.8 L 70.0 76.7 L 68.4 78.8 L 67.1 81.0 L 68.4 83.2 L 70.0 85.3 L 71.6 87.2 L 73.4 89.1 L 75.2 90.8 L 77.3 92.4 L 79.4 93.9 L 81.6 95.2 L 83.8 96.4 L 86.2 97.4 L 88.6 98.3 L 91.1 98.9 L 93.6 99.5 L 96.2 99.8 L 98.7 100.0 L 101.3 100.0 L 103.8 99.8 L 106.4 99.5 L 108.9 98.9 L 111.4 98.3 L 113.8 97.4 L 116.2 96.4 L 118.4 95.2 L 120.6 93.9 L 122.7 92.4 L 124.8 90.8 L 126.6 89.1 L 128.4 87.2 L 130.0 85.3 L 131.6 83.2 L 132.9 81.0 Z" stroke="#7A4F2E" stroke-width="0.7" fill="rgba(122,79,46,0.1)"/>
        <path d="M 132.9 119.0 L 134.1 116.7 L 135.2 114.4 L 136.1 112.0 L 136.8 109.5 L 137.3 107.0 L 137.7 104.5 L 138.0 101.9 L 138.0 99.4 L 137.9 96.8 L 137.6 94.2 L 137.1 91.7 L 136.4 89.2 L 135.6 86.8 L 134.7 84.4 L 133.5 82.1 L 132.2 79.9 L 130.8 77.8 L 129.2 75.7 L 127.5 73.8 L 125.7 72.0 L 123.8 70.3 L 121.7 68.8 L 119.6 67.4 L 117.3 66.2 L 115.0 65.1 L 112.6 64.1 L 110.1 63.4 L 107.6 62.8 L 105.1 62.3 L 102.6 62.1 L 100.0 62.0 L 98.8 64.3 L 97.7 66.6 L 96.8 69.0 L 96.1 71.5 L 95.6 74.0 L 95.2 76.5 L 95.0 79.1 L 94.9 81.6 L 95.0 84.2 L 95.3 86.8 L 95.8 89.3 L 96.5 91.8 L 97.3 94.2 L 98.2 96.6 L 99.4 98.9 L 100.7 101.1 L 102.1 103.2 L 103.7 105.3 L 105.4 107.2 L 107.2 109.0 L 109.1 110.7 L 111.2 112.2 L 113.4 113.6 L 115.6 114.8 L 117.9 115.9 L 120.3 116.9 L 122.8 117.6 L 125.3 118.2 L 127.8 118.7 L 130.3 118.9 L 132.9 119.0 Z" stroke="#7A4F2E" stroke-width="0.7" fill="rgba(122,79,46,0.1)"/>
        <path d="M 100.0 138.0 L 102.6 137.9 L 105.1 137.7 L 107.6 137.2 L 110.1 136.6 L 112.6 135.9 L 115.0 134.9 L 117.3 133.8 L 119.6 132.6 L 121.7 131.2 L 123.8 129.7 L 125.7 128.0 L 127.5 126.2 L 129.2 124.3 L 130.8 122.2 L 132.2 120.1 L 133.5 117.9 L 134.7 115.6 L 135.6 113.2 L 136.4 110.8 L 137.1 108.3 L 137.6 105.8 L 137.9 103.2 L 138.0 100.6 L 138.0 98.1 L 137.7 95.5 L 137.3 93.0 L 136.8 90.5 L 136.1 88.0 L 135.2 85.6 L 134.1 83.3 L 132.9 81.0 L 130.3 81.1 L 127.8 81.3 L 125.3 81.8 L 122.8 82.4 L 120.3 83.1 L 117.9 84.1 L 115.6 85.2 L 113.4 86.4 L 111.2 87.8 L 109.1 89.3 L 107.2 91.0 L 105.4 92.8 L 103.7 94.7 L 102.1 96.8 L 100.7 98.9 L 99.4 101.1 L 98.2 103.4 L 97.3 105.8 L 96.5 108.2 L 95.8 110.7 L 95.3 113.2 L 95.0 115.8 L 94.9 118.4 L 95.0 120.9 L 95.2 123.5 L 95.6 126.0 L 96.1 128.5 L 96.8 131.0 L 97.7 133.4 L 98.8 135.7 L 100.0 138.0 Z" stroke="#7A4F2E" stroke-width="0.7" fill="rgba(122,79,46,0.1)"/>
        <!-- Coffee bean -->
        <ellipse cx="100" cy="100" rx="6" ry="10" fill="rgba(122,79,46,0.36)" stroke="#7A4F2E" stroke-width="1.1" transform="rotate(-20 100 100)"/>
        <path d="M100 91 C97 94, 103 97, 100 100 C97 103, 103 106, 100 109" fill="none" stroke="#7A4F2E" stroke-width="0.85" stroke-linecap="round" transform="rotate(-20 100 100)" opacity="0.75"/>
      </g>
    </svg>
    <div style="display:flex;flex-direction:column;gap:0.18rem;">
      <div style="display:flex;align-items:baseline;gap:0.4rem;">
        <span style="font-family:'Josefin Sans',sans-serif;font-weight:200;font-size:0.44rem;letter-spacing:0.48em;text-transform:uppercase;color:rgba(122,79,46,0.42);line-height:1;">Gaias</span>
        <span style="font-family:'Cormorant Garamond',serif;font-weight:400;font-size:1.25rem;letter-spacing:0.25em;text-transform:uppercase;color:#1E1208;line-height:1;">Grounds</span>
      </div>
      <span style="font-family:'Cormorant Garamond',serif;font-style:italic;font-weight:300;font-size:0.62rem;letter-spacing:0.14em;color:rgba(122,79,46,0.38);line-height:1;">Of the Earth ¬∑ For the World</span>
    </div>
  </div>
  <div class="header-filters">
    <div class="filter-group">
      <span class="filter-label">Type</span>
      <select id="filter-type" onchange="applyFilters()">
        <option value="all">All</option>
        <option value="cafe">Caf√©s</option>
        <option value="roaster">Roasters</option>
        <option value="farm">Farms</option>
      </select>
    </div>
    <div class="filter-group">
      <span class="filter-label">Roast</span>
      <select id="filter-roast" onchange="applyFilters()">
        <option value="all">All Roasts</option>
        <option value="light">Light</option>
        <option value="light-medium">Light-Medium</option>
        <option value="medium">Medium</option>
        <option value="medium-dark">Medium-Dark</option>
        <option value="dark">Dark</option>
      </select>
    </div>
    <div class="filter-group">
      <span class="filter-label">Origin</span>
      <select id="filter-origin" onchange="applyFilters()">
        <option value="all">All Origins</option>
      </select>
    </div>
    <div class="filter-group">
      <span class="filter-label">Cert</span>
      <select id="filter-cert" onchange="applyFilters()">
        <option value="all">All</option>
        <option value="organic">Organic</option>
        <option value="fair-trade">Fair Trade</option>
        <option value="b-corp">B-Corp</option>
        <option value="direct-trade">Direct Trade</option>
        <option value="roc">Regenerative</option>
        <option value="woman-owned">Woman-Owned</option>
      </select>
    </div>
    <span class="count-badge" id="count-badge">‚Äî locations</span>
  </div>
</header>

<!-- Main Layout -->
<div class="layout" id="layout">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">Explore Locations</div>
      <input class="search-input" type="text" id="search-input"
        placeholder="Search caf√©s, roasters, farms‚Ä¶" oninput="handleSearch()"/>
    </div>
    <div class="locations-list" id="locations-list"></div>
    <div style="padding:1rem 1.5rem;border-top:1px solid rgba(122,79,46,0.07);display:flex;align-items:center;gap:0.6rem;flex-shrink:0;">
      <svg width="18" height="18" viewBox="60 60 80 80" fill="none" style="opacity:0.35;flex-shrink:0;">
        <defs><clipPath id="sb-clip"><circle cx="100" cy="100" r="39"/></clipPath></defs>
        <g clip-path="url(#sb-clip)">
          <ellipse cx="100" cy="100" rx="6" ry="9" stroke="#7A4F2E" stroke-width="1" fill="rgba(122,79,46,0.2)"/>
        </g>
      </svg>
      <span style="font-family:'Cormorant Garamond',serif;font-style:italic;font-size:0.7rem;letter-spacing:0.1em;color:rgba(122,79,46,0.3);">Of the Earth ¬∑ For the World</span>
    </div>
  </aside>
  <div id="map"></div>
</div>

<!-- Detail Panel -->
<div class="detail-panel" id="detail-panel">
  <button class="detail-close" onclick="closeDetail()">‚úï</button>
  <div id="detail-content"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // ‚îÄ‚îÄ DEMO DATA (used when Supabase is not yet configured) ‚îÄ‚îÄ
  const DEMO_DATA = [
    {id:'demo-1',name:'Caf√© de Flore',type_slug:'cafe',type_label:'Caf√©',city:'Paris',country_name:'France',lat:48.854,lng:2.333,description:'An iconic Parisian caf√© serving exquisite single-origin espresso since 1887.',specialty_drink:'Single-Origin Espresso',roast_label:'Light',roast_slug:'light',rating:4.8,is_verified:false,website:'https://cafedeflore.fr',phone:'+33 1 45 48 55 26',email:'info@cafedeflore.fr',image_emoji:'ü•ê',certification_slugs:[],origin_countries:['ET','CO']},
    {id:'demo-2',name:'Blue Bottle Coffee',type_slug:'roaster',type_label:'Roaster',city:'San Francisco',country_name:'USA',lat:37.7749,lng:-122.4194,description:'Pioneering third-wave roaster obsessed with freshness and transparency.',specialty_drink:'Pour Over',roast_label:'Light-Medium',roast_slug:'light-medium',rating:4.7,is_verified:true,website:'https://bluebottlecoffee.com',phone:'+1 510-653-3394',email:'hello@bluebottlecoffee.com',image_emoji:'üåâ',certification_slugs:['direct-trade','organic'],origin_countries:['ET','KE','CO']},
    {id:'demo-3',name:'Tim Wendelboe',type_slug:'roaster',type_label:'Roaster',city:'Oslo',country_name:'Norway',lat:59.9139,lng:10.7522,description:'World Barista Champion turned roaster. Legendary light roasts from direct trade farms.',specialty_drink:'Filter Coffee',roast_label:'Light',roast_slug:'light',rating:4.9,is_verified:true,website:'https://timwendelboe.no',phone:'+47 400 04 062',email:'post@timwendelboe.no',image_emoji:'üèîÔ∏è',certification_slugs:['direct-trade'],origin_countries:['ET','CO','BR']},
    {id:'demo-4',name:'Onibus Coffee',type_slug:'cafe',type_label:'Caf√©',city:'Tokyo',country_name:'Japan',lat:35.6762,lng:139.6503,description:"Tokyo's beloved specialty caf√© bridging Japanese precision with global coffee culture.",specialty_drink:'Japanese Iced Coffee',roast_label:'Medium-Light',roast_slug:'medium-light',rating:4.8,is_verified:false,website:'https://onibuscoffee.com',phone:'+81 3-6413-8048',email:'info@onibuscoffee.com',image_emoji:'üçµ',certification_slugs:[],origin_countries:['KE','BR']},
    {id:'demo-5',name:'Caf√© Granja La Esperanza',type_slug:'farm',type_label:'Farm',city:'Cali',country_name:'Colombia',lat:3.4516,lng:-76.532,description:'Award-winning coffee farm producing extraordinary experimental lots in the Cauca Valley.',specialty_drink:'Experimental Process',roast_label:'Light',roast_slug:'light',rating:4.9,is_verified:true,website:'https://granjalaesperanza.com',phone:'+57 2 555 1234',email:'info@granjalaesperanza.com',image_emoji:'üåø',certification_slugs:['organic','roc','woman-owned'],origin_countries:['CO']},
    {id:'demo-6',name:'Intelligentsia Coffee',type_slug:'roaster',type_label:'Roaster',city:'Chicago',country_name:'USA',lat:41.8827,lng:-87.6233,description:'Direct trade pioneers. Every cup tells the story of the farmer who grew it.',specialty_drink:'Direct Trade',roast_label:'Medium',roast_slug:'medium',rating:4.6,is_verified:true,website:'https://intelligentsiacoffee.com',phone:'+1 312-920-9390',email:'hello@intelligentsiacoffee.com',image_emoji:'üèôÔ∏è',certification_slugs:['direct-trade','b-corp'],origin_countries:['ET','GT','CO']},
    {id:'demo-7',name:'Five Elephant',type_slug:'roaster',type_label:'Roaster',city:'Berlin',country_name:'Germany',lat:52.52,lng:13.405,description:"Berlin's leading specialty roaster, famous for their cheesecake and exceptional filter coffee.",specialty_drink:'Filter & Espresso',roast_label:'Light-Medium',roast_slug:'light-medium',rating:4.7,is_verified:false,website:'https://fiveelephant.com',phone:'+49 30 96208925',email:'hello@fiveelephant.com',image_emoji:'üêò',certification_slugs:['fair-trade'],origin_countries:['RW','GT']},
    {id:'demo-8',name:'Proud Mary Coffee',type_slug:'roaster',type_label:'Roaster',city:'Melbourne',country_name:'Australia',lat:-37.8136,lng:144.9631,description:"Melbourne's world-class roaster known for boundary-pushing coffees and stunning presentation.",specialty_drink:'Specialty Espresso',roast_label:'Medium-Light',roast_slug:'medium-light',rating:4.8,is_verified:true,website:'https://proudmarycoffee.com.au',phone:'+61 3 9417 5930',email:'hello@proudmarycoffee.com.au',image_emoji:'ü¶ò',certification_slugs:['organic'],origin_countries:['ET','CO']},
    {id:'demo-9',name:"Kaldi's Coffee Farm",type_slug:'farm',type_label:'Farm',city:'Kaffa',country_name:'Ethiopia',lat:7.3333,lng:36.5667,description:'Named after the legendary goat herder who discovered coffee. Single estate, heirloom varieties.',specialty_drink:'Heirloom Ethiopian',roast_label:'Light',roast_slug:'light',rating:4.9,is_verified:true,website:'https://kaldiscoffee.et',phone:'+251 11 551 7700',email:'info@kaldiscoffee.et',image_emoji:'‚òï',certification_slugs:['organic','roc','shade-grown'],origin_countries:['ET']},
    {id:'demo-10',name:'Caf√© El Injerto',type_slug:'farm',type_label:'Farm',city:'Huehuetenango',country_name:'Guatemala',lat:15.3194,lng:-91.4727,description:"Multi-generational family farm producing some of the world's most coveted micro-lots.",specialty_drink:'Micro-Lot',roast_label:'Medium-Light',roast_slug:'medium-light',rating:4.8,is_verified:false,website:'https://elinjerto.com',phone:'+502 7764-1574',email:'info@elinjerto.com',image_emoji:'‚õ∞Ô∏è',certification_slugs:['fair-trade','organic'],origin_countries:['GT']},
  ];

  // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
  let allLocations  = [];
  let filteredData  = [];
  let markers       = {};
  let activeId      = null;

  // ‚îÄ‚îÄ SUPABASE CLIENT (minimal, no SDK needed) ‚îÄ‚îÄ
  const sb = {
    async get(table, params = {}) {
      if (!IS_CONFIGURED) return null;
      let url = `${SUPABASE_URL}/rest/v1/${table}?`;
      const qp = new URLSearchParams({ select: '*', ...params });
      const res = await fetch(url + qp, {
        headers: {
          'apikey': SUPABASE_ANON,
          'Authorization': `Bearer ${SUPABASE_ANON}`,
        }
      });
      if (!res.ok) throw new Error(`Supabase error: ${res.status}`);
      return res.json();
    },

    async rpc(fn, params = {}) {
      if (!IS_CONFIGURED) return null;
      const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_ANON,
          'Authorization': `Bearer ${SUPABASE_ANON}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(params),
      });
      if (!res.ok) throw new Error(`Supabase RPC error: ${res.status}`);
      return res.json();
    }
  };

  // ‚îÄ‚îÄ MAP INIT ‚îÄ‚îÄ
  const map = L.map('map', {
    center: [20, 10], zoom: 2.5,
    zoomControl: false, attributionControl: false,
  });
  L.control.zoom({ position: 'bottomright' }).addTo(map);
  L.control.attribution({ position: 'bottomright', prefix: '' }).addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors', maxZoom: 18,
  }).addTo(map);

  // ‚îÄ‚îÄ PIN ICON ‚îÄ‚îÄ
  function createPinIcon(typeSlug, isActive = false) {
    const colors = { cafe: '#7A4F2E', roaster: '#C4A25A', farm: '#6B7C5E' };
    const emojis = { cafe: '‚òï', roaster: 'üî•', farm: 'üåø' };
    const color  = colors[typeSlug] || '#7A4F2E';
    const emoji  = emojis[typeSlug] || '‚òï';
    const s = isActive ? 1.3 : 1;
    return L.divIcon({
      className: '',
      html: `<div style="width:${28*s}px;height:${28*s}px;background:${color};border:2px solid #F2EAD8;border-radius:50% 50% 50% 0;transform:rotate(-45deg);box-shadow:0 3px ${isActive?16:8}px rgba(30,18,8,${isActive?0.45:0.25});display:flex;align-items:center;justify-content:center;cursor:pointer;">
        <span style="transform:rotate(45deg);font-size:${11*s}px;line-height:1">${emoji}</span>
      </div>`,
      iconSize:    [28*s, 28*s],
      iconAnchor:  [14*s, 28*s],
      popupAnchor: [0, -30*s],
    });
  }

  // ‚îÄ‚îÄ DATA LOADING ‚îÄ‚îÄ
  async function loadLocations() {
    if (!IS_CONFIGURED) {
      // Use demo data, apply current filters
      const type    = document.getElementById('filter-type').value;
      const roast   = document.getElementById('filter-roast').value;
      const cert    = document.getElementById('filter-cert').value;
      const origin  = document.getElementById('filter-origin').value;
      const search  = document.getElementById('search-input').value.toLowerCase();

      let data = [...DEMO_DATA];
      if (type   !== 'all') data = data.filter(v => v.type_slug === type);
      if (roast  !== 'all') data = data.filter(v => v.roast_slug === roast);
      if (cert   !== 'all') data = data.filter(v => v.certification_slugs.includes(cert));
      if (origin !== 'all') data = data.filter(v => v.origin_countries.includes(origin));
      if (search) data = data.filter(v =>
        v.name.toLowerCase().includes(search) ||
        v.city.toLowerCase().includes(search) ||
        v.country_name.toLowerCase().includes(search) ||
        (v.specialty_drink||'').toLowerCase().includes(search)
      );
      allLocations = data;
      renderSidebar(data);
      renderMarkers(data);
      updateCount(data.length);
      return;
    }

    // ‚îÄ‚îÄ Live Supabase query via published_venues view ‚îÄ‚îÄ
    try {
      const type   = document.getElementById('filter-type').value;
      const roast  = document.getElementById('filter-roast').value;

      // Build query params for the view
      const params = {};
      if (type  !== 'all') params['type_slug']  = `eq.${type}`;
      if (roast !== 'all') params['roast_slug'] = `eq.${roast}`;
      params['order'] = 'name.asc';

      let data = await sb.get('published_venues', params);
      if (!data) data = [];

      // Client-side cert + origin filter (array containment)
      const cert   = document.getElementById('filter-cert').value;
      const origin = document.getElementById('filter-origin').value;
      if (cert   !== 'all') data = data.filter(v => (v.certification_slugs||[]).includes(cert));
      if (origin !== 'all') data = data.filter(v => (v.origin_countries||[]).includes(origin));

      // Search
      const search = document.getElementById('search-input').value.toLowerCase();
      if (search) data = data.filter(v =>
        v.name.toLowerCase().includes(search) ||
        v.city.toLowerCase().includes(search) ||
        (v.country_name||'').toLowerCase().includes(search)
      );

      allLocations = data;
      renderSidebar(data);
      renderMarkers(data);
      updateCount(data.length);

    } catch(err) {
      console.error('Supabase fetch error:', err);
    }
  }

  async function loadOriginOptions() {
    const sel = document.getElementById('filter-origin');
    if (!IS_CONFIGURED) {
      // Build from demo data
      const codes = [...new Set(DEMO_DATA.flatMap(v => v.origin_countries))].sort();
      const labels = { ET:'Ethiopia',KE:'Kenya',CO:'Colombia',BR:'Brazil',GT:'Guatemala',RW:'Rwanda' };
      codes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = labels[c] || c;
        sel.appendChild(opt);
      });
      return;
    }
    try {
      const countries = await sb.get('countries', { is_producer: 'eq.true', order: 'name.asc', select: 'code,name' });
      if (countries) {
        countries.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.code;
          opt.textContent = c.name;
          sel.appendChild(opt);
        });
      }
    } catch(e) { console.error(e); }
  }

  // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
  function renderSidebar(locations) {
    const list = document.getElementById('locations-list');
    list.innerHTML = '';
    if (!locations.length) {
      list.innerHTML = `<div style="text-align:center;padding:3rem 1rem;color:rgba(122,79,46,0.3);font-style:italic;font-size:0.9rem">No locations match this filter.</div>`;
      return;
    }
    locations.forEach(loc => {
      const card = document.createElement('div');
      card.className = `location-card${loc.id === activeId ? ' active' : ''}`;
      card.dataset.id = loc.id;

      const certChips = (loc.certification_slugs||[]).slice(0,2).map(c =>
        `<span class="tag tag-cert">${c.replace('-',' ')}</span>`
      ).join('');

      card.innerHTML = `
        <div class="card-top">
          <span class="card-emoji">${loc.image_emoji||'‚òï'}</span>
          <span class="card-name">${loc.name}${loc.is_verified ? ' <span style="font-size:0.65rem;color:#3D5C38;">‚úì</span>' : ''}</span>
          <span class="card-rating">‚òÖ ${loc.rating}</span>
        </div>
        <div class="card-location">${loc.city}, ${loc.country_name}</div>
        <div class="card-tags">
          <span class="tag tag-type">${loc.type_label}</span>
          <span class="tag tag-roast">${loc.roast_label}</span>
          ${certChips}
        </div>`;
      card.addEventListener('click', () => selectLocation(loc.id));
      list.appendChild(card);
    });
  }

  function renderMarkers(locations) {
    Object.values(markers).forEach(m => map.removeLayer(m));
    markers = {};
    locations.forEach(loc => {
      const lat = loc.lat ?? loc.venue_lat;
      const lng = loc.lng ?? loc.venue_lng;
      if (!lat || !lng) return;
      const marker = L.marker([lat, lng], { icon: createPinIcon(loc.type_slug, false) }).addTo(map);
      marker.bindPopup(`
        <div class="popup-name">${loc.image_emoji||'‚òï'} ${loc.name}</div>
        <div class="popup-sub">${loc.city}, ${loc.country_name} ¬∑ ${loc.specialty_drink||''}</div>
        <button class="popup-btn" onclick="selectLocation('${loc.id}')">Explore ‚Üí</button>
      `, { closeButton: false, maxWidth: 220 });
      marker.on('click', () => selectLocation(loc.id));
      markers[loc.id] = marker;
    });
  }

  function updateCount(n) {
    document.getElementById('count-badge').textContent = `${n} location${n!==1?'s':''}`;
  }

  // ‚îÄ‚îÄ SELECT ‚îÄ‚îÄ
  function selectLocation(id) {
    if (activeId) {
      document.querySelector(`.location-card[data-id="${activeId}"]`)?.classList.remove('active');
      const prev = allLocations.find(l => l.id == activeId);
      if (prev && markers[activeId]) markers[activeId].setIcon(createPinIcon(prev.type_slug, false));
    }
    activeId = id;
    const loc = allLocations.find(l => l.id == id);
    if (!loc) return;

    document.querySelector(`.location-card[data-id="${id}"]`)?.classList.add('active');
    document.querySelector(`.location-card[data-id="${id}"]`)?.scrollIntoView({ behavior:'smooth', block:'nearest' });

    if (markers[id]) {
      markers[id].setIcon(createPinIcon(loc.type_slug, true));
      const lat = loc.lat ?? loc.venue_lat;
      const lng = loc.lng ?? loc.venue_lng;
      map.setView([lat, lng], Math.max(map.getZoom(), 5), { animate:true, duration:0.5 });
      markers[id].openPopup();
    }
    showDetail(loc);
  }

  async function showDetail(loc) {
    const panel   = document.getElementById('detail-panel');
    const content = document.getElementById('detail-content');

    // Fetch products from Supabase if connected
    let productsHTML = '';
    if (IS_CONFIGURED) {
      try {
        const products = await sb.get('products', {
          venue_id: `eq.${loc.id}`,
          is_available: 'eq.true',
          order: 'is_featured.desc,name.asc',
        });
        if (products && products.length) {
          productsHTML = products.map(p => `
            <div class="product-item">
              <div class="product-top">
                <span class="product-name">${p.name}</span>
                <span class="product-price">${p.price||''}</span>
              </div>
              ${p.tasting_notes ? `<div class="product-notes">‚Ü≥ ${p.tasting_notes}</div>` : ''}
              ${p.origin_region  ? `<div class="product-meta">${p.origin_region}${p.variety ? ' ¬∑ '+p.variety : ''}${p.altitude_masl ? ' ¬∑ '+p.altitude_masl+'m' : ''}</div>` : ''}
            </div>`).join('');
        }
      } catch(e) { console.error(e); }
    }

    if (!productsHTML) {
      productsHTML = `<div style="font-style:italic;font-size:0.85rem;color:rgba(122,79,46,0.35);padding:0.5rem 0;">No products listed yet.</div>`;
    }

    const certChips = (loc.certification_slugs||[]).map(c =>
      `<span class="tag tag-cert">${c.replace(/-/g,' ')}</span>`
    ).join('');

    const verifiedBadge = loc.is_verified
      ? `<span class="verified-badge">‚úì &nbsp;Verified</span>` : '';

    content.innerHTML = `
      <div class="detail-hero">
        <span class="detail-emoji">${loc.image_emoji||'‚òï'}</span>
        <div class="detail-name">${loc.name}</div>
        <div class="detail-location">üìç ${loc.city}, ${loc.country_name}</div>
        <div class="detail-meta">
          <span class="tag tag-type">${loc.type_label}</span>
          <span class="tag tag-roast">${loc.roast_label} Roast</span>
          <span class="tag tag-roast">‚òÖ ${loc.rating}</span>
          ${verifiedBadge}
        </div>
        <div class="detail-description">${loc.description||''}</div>
      </div>

      ${certChips ? `
      <div class="detail-section">
        <div class="section-label">Certifications</div>
        <div class="cert-chips">${certChips}</div>
      </div>` : ''}

      <div class="detail-section">
        <div class="section-label">Signature Offerings</div>
        ${productsHTML}
      </div>

      <div class="detail-section">
        <div class="section-label">Contact & Links</div>
        <div class="contact-grid">
          ${loc.phone   ? `<div class="contact-item"><span class="contact-icon">Phone</span><span class="contact-value">${loc.phone}</span></div>` : ''}
          ${loc.email   ? `<div class="contact-item"><span class="contact-icon">Email</span><span class="contact-value"><a href="mailto:${loc.email}">${loc.email}</a></span></div>` : ''}
          ${loc.website ? `<div class="contact-item"><span class="contact-icon">Web</span><span class="contact-value"><a href="${loc.website}" target="_blank">${loc.website.replace('https://','')}</a></span></div>` : ''}
        </div>
      </div>`;

    panel.classList.add('open');
  }

  function closeDetail() {
    document.getElementById('detail-panel').classList.remove('open');
    if (activeId) {
      document.querySelector(`.location-card[data-id="${activeId}"]`)?.classList.remove('active');
      const prev = allLocations.find(l => l.id == activeId);
      if (prev && markers[activeId]) markers[activeId].setIcon(createPinIcon(prev.type_slug, false));
    }
    activeId = null;
  }

  // ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ
  function applyFilters() { loadLocations(); }

  function handleSearch() { loadLocations(); }

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
  async function init() {
    // Show/hide config banner
    if (IS_CONFIGURED) {
      document.getElementById('config-banner').classList.add('hidden');
    } else {
      document.getElementById('layout').classList.add('with-banner');
    }

    await Promise.all([loadLocations(), loadOriginOptions()]);

    setTimeout(() => {
      document.getElementById('loading').classList.add('hidden');
    }, 1100);
  }

  init();
</script>
</body>
</html>
